## 何为RPC



RPC，即Remote Procedure Call，远程过程调度。可以让一台机器（客户端）上通过参数传递的方式调用另一台机器（服务端）上的函数或方法，并得到返回结果。



与之相对的是 IPC，即Inter Process Communication， 单机内进程间通讯

### 发展背景

在早期，所有的服务都在一台机器上，不同服务使用不同的进程来实现。而不同服务间的通讯，就是同一机器上不同进程的通讯。



在随着网络和用户体量的发展，单机已经无法提供如此大体量的服务。在互联网的联系下，通常是由一台甚至多台机器来提供一个服务。不同服务间的通讯，就需要跨越网络。这就是RPC诞生的背景



![image-20210313115440388](https://gitee.com/Vanni/pic-bed/raw/master/img/image-20210313115440388.png)



- 简单的说，RPC就是从一台机器（客户端）上通过参数传递的方式调用另一台机器（服务器）上的一个函数或方法（可以统称为服务）并得到返回的结果。
- RPC 会隐藏底层的通讯细节（不需要直接处理Socket通讯或Http通讯）
- RPC 是一个请求响应模型。客户端发起请求，服务器返回响应（类似于Http的工作方式）
- RPC 在使用形式上像调用本地函数（或方法）一样去调用远程的函数（或方法）。



### 实现细节

实现一个RPC通讯，其调用协议通常包含传输协议和序列化协议

**传输是在网络中进行的，需对参数和结果进行序列化的操作**



现有流行的实现RPC的传输协议有：gRPC使用的http2协议，dubbo一类的使用自定义的tcp协议，UDP，总的来说就是基于TCP和HTTP



序列化协议包括：基于文本编码的JSON，XML，也有基于二进制编码的protobuf hessian等

## TCP实现



远程控制调度RPC的本质还是底层的Socket通信，其基本思路如下



1. 服务的调用方Consumer通过Socket建立起与服务的提供方Provider的连接；
2. Consumer将需要调用的方法名称和参数通过Socket发送给Provider；
3. Provider获取Consumer请求的数据并进行解析，执行具体的某一个方法，构造返回数据，返回给Consumer；
4. Consumer获得Provider返回的数据进行相应的处理；

rpc框架的不同之处，就在于序列化协议的选择和内容的封装上



## HTTP实现

Rpc是一种概念，而http是实现rpc的一种方式而已。

http的开发模式，就是常见的restful风格服务接口，简单，开发方便，直接利用现成的http协议进行传输。

较于tcp的方式，socket是长连接的方式，而http每次通信都需要进行三次握手建立连接，且http报文头中是使用基于文本编码的header头，这些信息在rpc调用里，算是无用信息



## 两者对比

- 一般来说http协议用字符串通信，base64编码。数据密度没有二进制的高。
- http也可以用二进制数据，MIME特殊的响应头，就可以传协议上的二进制类型数据
- TCP基于流，仍然要自定义协议，最简单的协议头【长度4bytes，类型2bytes】
- 这个协议头比HTTP要更短，所以传输的内容更少
- TCP协议头相比HTTP中的文本编码头部更为容易解析



## 总结



论复杂度，RPC框架是要高于http接口的。HTTP接口受限于HTTP协议，需要携带http请求头，传输效率和安全性都不如RPC框架中的自定义tcp协议。



http接口是在接口不多、系统与系统交互较少的情况下，解决信息孤岛初期常使用的一种通信手段；**优点**就是简单、直接、开发方便。利用现成的http协议 进行传输。但是如果是一个大型的网站，内部子系统较多、接口非常多的情况下，RPC框架的好处就显示出来了，首先就是**长链接**，不必每次通信都要像http 一样去3次握手什么的，减少了网络开销；其次就是RPC框架一般都有注册中心，有丰富的监控管理；发布、下线接口、动态扩展等，对调用方来说是无感知、统 一化的操作。第三个来说就是安全性。最后就是最近流行的服务化架构、服务化治理，RPC框架是一个强力的支撑。



**RPC的核心并不在于使用什么协议。RPC的目的是让你在本地调用远程的方法，而对你来说这个调用是透明的**，你并不知道这个调用的方法是部署哪里。通过RPC能解耦服务，这才是使用RPC的真正目的。RPC的原理主要用到了动态代理模式，至于http协议，只是传输协议而已。简单的实现可以参考spring remoting，复杂的实现可以参考dubbo。



